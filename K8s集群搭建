 Kubernetes v1.28.2 + containerd + Flannel ç½‘ç»œæ’ä»¶ï¼ˆCentOS 7ï¼‰
âœ… ä¸€ã€åŸºç¡€ç¯å¢ƒè§„åˆ’
èŠ‚ç‚¹ ä¸»æœºå IP åœ°å€
Master k8s-master01 10.48.88.161
Node1 k8s-node01 10.48.88.162
Node2 k8s-node02 10.48.88.163
ğŸ§± äºŒã€æ‰€æœ‰èŠ‚ç‚¹é€šç”¨è®¾ç½®
2.1 è®¾ç½®ä¸»æœºåå’Œ hosts
bash
å¤åˆ¶
ç¼–è¾‘
hostnamectl set-hostname k8s-master01 # å…¶ä»–èŠ‚ç‚¹è¯·æ”¹å
cat >> /etc/hosts <10.48.88.161 k8s-master01
10.48.88.162 k8s-node01
10.48.88.163 k8s-node02
EOF
2.2 å…³é—­é˜²ç«å¢™ã€SELinuxã€Swap
bash
å¤åˆ¶
ç¼–è¾‘
systemctl disable --now firewalld
setenforce 0
sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab
2.3 ç³»ç»Ÿå†…æ ¸ä¼˜åŒ–å‚æ•°
bash
å¤åˆ¶
ç¼–è¾‘
modprobe overlay
modprobe br_netfilter
cat < /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
sysctl --system
2.4 è®¾ç½®å›½å†… DNS
bash
å¤åˆ¶
ç¼–è¾‘
echo "nameserver 223.5.5.5" > /etc/resolv.conf
ğŸ“¦ ä¸‰ã€å®‰è£… containerd å’Œ kubelet ç»„ä»¶
3.1 å®‰è£… containerd
bash
å¤åˆ¶
ç¼–è¾‘
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install -y containerd
ç”Ÿæˆå¹¶ä¿®æ”¹é…ç½®
bash
å¤åˆ¶
ç¼–è¾‘
containerd config default > /etc/containerd/config.toml
# æ›¿æ¢ pause é•œåƒå’Œå›½å†…é•œåƒæº
sed -i 's|sandbox_image = .*|sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"|' /etc/containerd/config.toml
sed -i 's|registry.k8s.io|registry.aliyuncs.com/google_containers|g' /etc/containerd/config.toml
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
systemctl daemon-reexec
systemctl enable --now containerd
3.2 å®‰è£… kubeadmã€kubeletã€kubectl
bash
å¤åˆ¶
ç¼–è¾‘
cat < /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
EOF
yum install -y kubelet-1.28.2 kubeadm-1.28.2 kubectl-1.28.2
systemctl enable --now kubelet
ğŸš€ å››ã€åˆå§‹åŒ– Master èŠ‚ç‚¹
4.1 kubeadm init åˆå§‹åŒ–å‘½ä»¤
bash
å¤åˆ¶
ç¼–è¾‘
kubeadm init \
--apiserver-advertise-address=10.48.88.161 \
--image-repository registry.aliyuncs.com/google_containers \
--kubernetes-version v1.28.2 \
--pod-network-cidr=10.244.0.0/16 \
--service-cidr=10.96.0.0/12 \
--ignore-preflight-errors=Swap
æ³¨æ„ï¼šFlannel é»˜è®¤ Pod ç½‘æ®µæ˜¯ 10.244.0.0/16
4.2 è®¾ç½® kubeconfig æ–‡ä»¶
bash
å¤åˆ¶
ç¼–è¾‘
mkdir -p $HOME/.kube
cp /etc/kubernetes/admin.conf ~/.kube/config
chown $(id -u):$(id -g) ~/.kube/config
ğŸŒ äº”ã€å®‰è£… Flannel ç½‘ç»œæ’ä»¶
ä½¿ç”¨ GitHub å®˜æ–¹åœ°å€ï¼š
bash
å¤åˆ¶
ç¼–è¾‘
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
âš  å¦‚æœä½ è®¿é—® GitHub è¾ƒæ…¢ï¼Œå»ºè®®æå‰ä¸‹è½½ .yml æ–‡ä»¶ï¼Œä¼ åˆ°æœåŠ¡å™¨æœ¬åœ° kubectl apply -f kube-flannel.ymlã€‚
ğŸ“¡ å…­ã€Node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤
6.1 ç”Ÿæˆ join å‘½ä»¤ï¼ˆMaster èŠ‚ç‚¹æ‰§è¡Œï¼‰
bash
å¤åˆ¶
ç¼–è¾‘
kubeadm token create --print-join-command
ç¤ºä¾‹è¾“å‡ºï¼š
bash
å¤åˆ¶
ç¼–è¾‘
kubeadm join 10.48.88.161:6443 --token abcdef.0123456789abcdef \
--discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6.2 Node èŠ‚ç‚¹æ‰§è¡Œ join å‘½ä»¤
æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œè¯¥å‘½ä»¤ã€‚
âœ… ä¸ƒã€éªŒè¯é›†ç¾¤çŠ¶æ€
bash
å¤åˆ¶
ç¼–è¾‘
kubectl get nodes -o wide
kubectl get pods -A
ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹ä¸º Readyï¼Œæ‰€æœ‰ç»„ä»¶ä¸º Runningã€‚
ğŸ“Š å…«ã€éƒ¨ç½²æµç¨‹åˆ†æ
é¡¹ç›® è¯´æ˜
ğŸ§© ç³»ç»Ÿè®¾ç½®ä¼˜åŒ– ç¦ç”¨ swapã€é˜²ç«å¢™ï¼Œå¼€å¯æ¡¥æ¥è½¬å‘ï¼Œå…¼å®¹ kubelet è¦æ±‚
ğŸ“¦ containerd ä½¿ç”¨ pause:3.9 å’Œ aliyun registry è§£å†³é•œåƒæ‹‰å–æ…¢
ğŸ§° kubeadm å®‰è£… ç‰ˆæœ¬å·å›ºå®šï¼ˆ1.28.2ï¼‰ï¼Œå¯æ§ã€ç¨³å®šã€å®˜æ–¹æ”¯æŒ
ğŸŒ Flannel ç½‘ç»œæ’ä»¶ é»˜è®¤ä½¿ç”¨ 10.244.0.0/16ï¼Œå®‰è£…ç®€å•ï¼Œå…¼å®¹æ€§å¥½
ğŸ›°ï¸ ç½‘ç»œæ’ä»¶åœ°å€å·®å¼‚ ä½¿ç”¨ raw.githubusercontent.com è®¿é—®å¯èƒ½æ…¢ï¼Œå»ºè®®å›½å†…æå‰ç¼“å­˜
ğŸ“¦ é•œåƒä»“åº“è®¾ç½® å…¨éƒ¨æ›¿æ¢ä¸ºé˜¿é‡Œäº‘ï¼Œè§£å†³å›½å†…æ— æ³•è®¿é—® registry.k8s.io çš„é—®é¢˜
ğŸ“¡ èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ ä½¿ç”¨ token+CA hash å®‰å…¨è®¤è¯ï¼Œé¿å…ä¼ªé€ èŠ‚ç‚¹
ğŸ” åç»­å»ºè®® å®‰è£… Dashboardã€Metrics Serverã€Ingress ç­‰ç»„ä»¶æ‰©å±•ç®¡ç†èƒ½åŠ›
ğŸ“ é™„åŠ å»ºè®®
âœ… å¯ä»¥å°† kube-flannel.yml ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶ç”¨äºç¦»çº¿éƒ¨ç½²ï¼›
âœ… å¦‚æœæƒ³ä½¿ç”¨ Calicoã€Cilium æ›¿ä»£ Flannelï¼Œå¯è·å¾—æ›´å¼ºçš„ç½‘ç»œç­–ç•¥æ”¯æŒï¼›
âœ… åç»­å¦‚éœ€éƒ¨ç½²é«˜å¯ç”¨ï¼ˆå¤š Masterï¼‰ç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨ HAProxy + Keepalived æ–¹æ¡ˆï¼›
